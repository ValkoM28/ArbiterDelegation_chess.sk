<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Arbiter Delegation Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            Chess Arbiter Delegation Generator
        </h1>
        
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
            <!-- Load External Data Section -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">External Data</h2>
                <div class="mb-4">
                    <label for="seasonYear" class="block text-sm font-medium text-gray-700 mb-2">
                        Season Start Year:
                    </label>
                    <input 
                        type="number" 
                        id="seasonYear" 
                        value="2024"
                        min="2020" 
                        max="2030"
                        class="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <button 
                    id="loadDataBtn" 
                    onclick="loadExternalData()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-200"
                >
                    Load External Data
                </button>
                <div id="loadStatus" class="mt-2 text-sm"></div>
                
                <!-- Data Preview -->
                <div id="dataPreview" class="mt-4 hidden">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Loaded Data Preview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-medium text-gray-600">Arbiters</h4>
                            <div id="arbitersPreview" class="text-sm text-gray-500"></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-600">Leagues</h4>
                            <div id="leaguesPreview" class="text-sm text-gray-500"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Arbiter Selection Section -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Arbiter Selection</h2>
                <div class="mb-4">
                    <label for="arbiterSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        Select an Arbiter:
                    </label>
                    <select 
                        id="arbiterSelect" 
                        onchange="onArbiterSelected()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled
                    >
                        <option value="">First load external data to see arbiters</option>
                    </select>
                </div>
                
                <!-- Arbiter Details -->
                <div id="arbiterDetails" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Selected Arbiter</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                            <input 
                                type="text" 
                                id="arbiterNameField" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                readonly
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Player ID</label>
                            <input 
                                type="text" 
                                id="arbiterIdField" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                readonly
                            />
                        </div>
                    </div>
                </div>
            </div>

            <!-- League Selection Section -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">League Selection</h2>
                <div class="mb-4">
                    <label for="leagueSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        Select a League:
                    </label>
                    <select 
                        id="leagueSelect" 
                        onchange="onLeagueSelected()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled
                    >
                        <option value="">First load external data to see leagues</option>
                    </select>
                </div>
                
                <!-- Preset Fields -->
                <div id="presetFields" class="hidden">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Preset Fields</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Director</label>
                            <input 
                                type="text" 
                                id="directorField" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                readonly
                            />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Director Contact</label>
                            <input 
                                type="text" 
                                id="directorContactField" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                readonly
                            />
                        </div>
                    </div>
                </div>
            </div>

            <!-- PDF Data Preparation Section -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">PDF Data Preparation</h2>
                <button 
                    id="preparePdfBtn"
                    onclick="preparePDFData()"
                    class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded transition duration-200 mr-2"
                    disabled
                >
                    Prepare PDF Data
                </button>
                <div id="prepareStatus" class="mt-2 text-sm"></div>
            </div>

            <!-- PDF Generation Section -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">PDF Generation</h2>
                <button 
                    onclick="listFields()"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-200 mr-2"
                >
                    List PDF Fields
                </button>
                <button 
                    onclick="generatePDF()"
                    class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded transition duration-200"
                >
                    Generate PDF
                </button>
            </div>

            <!-- Status Messages -->
            <div id="status" class="text-sm text-gray-600"></div>
        </div>
    </div>

    <script>
        async function loadExternalData() {
            const btn = document.getElementById('loadDataBtn');
            const status = document.getElementById('loadStatus');
            const seasonYear = document.getElementById('seasonYear').value;
            
            btn.disabled = true;
            btn.textContent = 'Loading...';
            status.textContent = 'Loading external data...';
            
            try {
                const response = await fetch('/load-external-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        seasonStartYear: seasonYear
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    status.innerHTML = `
                        <span class="text-green-600">✓ ${result.message}</span><br>
                        <span class="text-sm">Arbiters: ${result.arbiters_loaded ? 'Loaded' : 'Not loaded'}</span><br>
                        <span class="text-sm">Leagues: ${result.leagues_loaded ? 'Loaded' : 'Not loaded'}</span>
                    `;
                    
                    // Show data preview and populate dropdowns
                    if (result.arbiters_loaded && result.leagues_loaded) {
                        showDataPreview();
                        populateArbiterDropdown();
                        populateLeagueDropdown();
                    }
                } else {
                    status.innerHTML = `<span class="text-red-600">✗ Error: ${result.error}</span>`;
                }
            } catch (error) {
                status.innerHTML = `<span class="text-red-600">✗ Network error: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Load External Data';
            }
        }

        async function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            const arbitersPreview = document.getElementById('arbitersPreview');
            const leaguesPreview = document.getElementById('leaguesPreview');
            
            try {
                // Fetch arbiters data
                const arbitersResponse = await fetch('/arbiters');
                const arbitersData = await arbitersResponse.json();
                
                if (arbitersData.arbiters && arbitersData.arbiters.length > 0) {
                    const firstFew = arbitersData.arbiters.slice(0, 3);
                    arbitersPreview.innerHTML = firstFew.map(arbiter => 
                        `<div>• ${arbiter.FirstName} ${arbiter.LastName} (${arbiter.ArbiterLevel})</div>`
                    ).join('');
                    if (arbitersData.arbiters.length > 3) {
                        arbitersPreview.innerHTML += `<div class="text-gray-400">... and ${arbitersData.arbiters.length - 3} more</div>`;
                    }
                } else {
                    arbitersPreview.innerHTML = '<div class="text-gray-400">No arbiters data</div>';
                }

                // Fetch leagues data
                const leaguesResponse = await fetch('/leagues');
                const leaguesData = await leaguesResponse.json();
                
                if (leaguesData.leagues && leaguesData.leagues.length > 0) {
                    const firstFew = leaguesData.leagues.slice(0, 3);
                    leaguesPreview.innerHTML = firstFew.map(league => 
                        `<div>• ${league.leagueName} (${league.saisonName})</div>`
                    ).join('');
                    if (leaguesData.leagues.length > 3) {
                        leaguesPreview.innerHTML += `<div class="text-gray-400">... and ${leaguesData.leagues.length - 3} more</div>`;
                    }
                } else {
                    leaguesPreview.innerHTML = '<div class="text-gray-400">No leagues data</div>';
                }

                // Show the preview
                preview.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading data preview:', error);
            }
        }

        async function populateArbiterDropdown() {
            const arbiterSelect = document.getElementById('arbiterSelect');
            
            try {
                const response = await fetch('/arbiters');
                const data = await response.json();
                
                if (data.arbiters && data.arbiters.length > 0) {
                    // Clear existing options
                    arbiterSelect.innerHTML = '<option value="">Select an arbiter...</option>';
                    
                    // Add arbiter options
                    data.arbiters.forEach(arbiter => {
                        const option = document.createElement('option');
                        option.value = arbiter.ArbiterId;
                        option.textContent = `${arbiter.FirstName} ${arbiter.LastName} (${arbiter.ArbiterLevel})`;
                        arbiterSelect.appendChild(option);
                    });
                    
                    // Enable the dropdown
                    arbiterSelect.disabled = false;
                } else {
                    arbiterSelect.innerHTML = '<option value="">No arbiters available</option>';
                }
            } catch (error) {
                console.error('Error loading arbiters:', error);
                arbiterSelect.innerHTML = '<option value="">Error loading arbiters</option>';
            }
        }

        async function populateLeagueDropdown() {
            const leagueSelect = document.getElementById('leagueSelect');
            
            try {
                const response = await fetch('/leagues');
                const data = await response.json();
                
                if (data.leagues && data.leagues.length > 0) {
                    // Clear existing options
                    leagueSelect.innerHTML = '<option value="">Select a league...</option>';
                    
                    // Add league options
                    data.leagues.forEach(league => {
                        const option = document.createElement('option');
                        option.value = league.leagueId;
                        option.textContent = `${league.leagueName} (${league.saisonName})`;
                        leagueSelect.appendChild(option);
                    });
                    
                    // Enable the dropdown
                    leagueSelect.disabled = false;
                } else {
                    leagueSelect.innerHTML = '<option value="">No leagues available</option>';
                }
            } catch (error) {
                console.error('Error loading leagues:', error);
                leagueSelect.innerHTML = '<option value="">Error loading leagues</option>';
            }
        }

        function onArbiterSelected() {
            const arbiterSelect = document.getElementById('arbiterSelect');
            const arbiterDetails = document.getElementById('arbiterDetails');
            const arbiterNameField = document.getElementById('arbiterNameField');
            const arbiterIdField = document.getElementById('arbiterIdField');
            
            if (arbiterSelect.value) {
                // Show arbiter details
                arbiterDetails.classList.remove('hidden');
                
                // Fetch specific arbiter data
                fetchArbiterDetails(arbiterSelect.value);
            } else {
                // Hide arbiter details
                arbiterDetails.classList.add('hidden');
                arbiterNameField.value = '';
                arbiterIdField.value = '';
            }
            
            // Update prepare PDF button state
            updatePreparePdfButtonState();
        }

        function onLeagueSelected() {
            const leagueSelect = document.getElementById('leagueSelect');
            const presetFields = document.getElementById('presetFields');
            const directorField = document.getElementById('directorField');
            const directorContactField = document.getElementById('directorContactField');
            
            if (leagueSelect.value) {
                // Show preset fields
                presetFields.classList.remove('hidden');
                
                // Fetch specific league data
                fetchLeagueDetails(leagueSelect.value);
            } else {
                // Hide preset fields
                presetFields.classList.add('hidden');
                directorField.value = '';
                directorContactField.value = '';
            }
            
            // Update prepare PDF button state
            updatePreparePdfButtonState();
        }

        async function fetchArbiterDetails(arbiterId) {
            const arbiterNameField = document.getElementById('arbiterNameField');
            const arbiterIdField = document.getElementById('arbiterIdField');
            
            // Show loading state
            arbiterNameField.value = 'Loading...';
            arbiterIdField.value = 'Loading...';
            
            try {
                const response = await fetch(`/arbiters/${arbiterId}`);
                const data = await response.json();
                
                if (data.arbiter) {
                    // Update fields with real arbiter data
                    arbiterNameField.value = `${data.arbiter.FirstName} ${data.arbiter.LastName}`;
                    arbiterIdField.value = data.arbiter.PlayerId || 'N/A';
                } else {
                    arbiterNameField.value = 'Arbiter not found';
                    arbiterIdField.value = 'N/A';
                }
            } catch (error) {
                console.error('Error fetching arbiter details:', error);
                arbiterNameField.value = 'Error loading data';
                arbiterIdField.value = 'Error loading data';
            }
        }

        async function fetchLeagueDetails(leagueId) {
            const directorField = document.getElementById('directorField');
            const directorContactField = document.getElementById('directorContactField');
            
            // Show loading state
            directorField.value = 'Loading...';
            directorContactField.value = 'Loading...';
            
            try {
                const response = await fetch(`/leagues/${leagueId}`);
                const data = await response.json();
                
                if (data.league) {
                    // Update fields with real league data
                    directorField.value = `${data.league.directorFirstName} ${data.league.directorSurname}`;
                    directorContactField.value = data.league.directorEmail || 'Contact not specified';
                } else {
                    directorField.value = 'League not found';
                    directorContactField.value = 'Contact not available';
                }
            } catch (error) {
                console.error('Error fetching league details:', error);
                directorField.value = 'Error loading data';
                directorContactField.value = 'Error loading data';
            }
        }

        function updatePreparePdfButtonState() {
            const arbiterSelect = document.getElementById('arbiterSelect');
            const leagueSelect = document.getElementById('leagueSelect');
            const preparePdfBtn = document.getElementById('preparePdfBtn');
            
            // Enable button only if both arbiter and league are selected
            if (arbiterSelect.value && leagueSelect.value) {
                preparePdfBtn.disabled = false;
            } else {
                preparePdfBtn.disabled = true;
            }
        }

        async function preparePDFData() {
            const arbiterSelect = document.getElementById('arbiterSelect');
            const leagueSelect = document.getElementById('leagueSelect');
            const prepareStatus = document.getElementById('prepareStatus');
            const preparePdfBtn = document.getElementById('preparePdfBtn');
            
            if (!arbiterSelect.value || !leagueSelect.value) {
                prepareStatus.innerHTML = '<span class="text-red-600">Please select both an arbiter and a league first.</span>';
                return;
            }
            
            preparePdfBtn.disabled = true;
            preparePdfBtn.textContent = 'Preparing...';
            prepareStatus.textContent = 'Preparing PDF data...';
            
            try {
                const response = await fetch('/prepare-pdf-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        arbiterId: parseInt(arbiterSelect.value),
                        leagueId: parseInt(leagueSelect.value)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    prepareStatus.innerHTML = `
                        <span class="text-green-600">✓ ${result.message}</span><br>
                        <span class="text-sm">Data has been printed to the server console.</span>
                    `;
                } else {
                    prepareStatus.innerHTML = `<span class="text-red-600">✗ Error: ${result.error}</span>`;
                }
            } catch (error) {
                prepareStatus.innerHTML = `<span class="text-red-600">✗ Network error: ${error.message}</span>`;
            } finally {
                preparePdfBtn.disabled = false;
                preparePdfBtn.textContent = 'Prepare PDF Data';
            }
        }

        async function listFields() {
            const status = document.getElementById('status');
            status.textContent = 'Listing PDF fields...';
            
            try {
                const response = await fetch('/list-fields');
                const result = await response.json();
                
                if (response.ok) {
                    status.textContent = '✓ Fields listed to console. Check server logs for details.';
                } else {
                    status.textContent = `✗ Error: ${result.error}`;
                }
            } catch (error) {
                status.textContent = `✗ Network error: ${error.message}`;
            }
        }

        async function generatePDF() {
            const status = document.getElementById('status');
            status.textContent = 'Generating PDF...';
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        // Add your PDF field data here
                        test_field: 'Test Value'
                    })
                });
                
                if (response.ok) {
                    // Download the PDF
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'delegacny.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    status.textContent = '✓ PDF generated and downloaded!';
                } else {
                    const result = await response.json();
                    status.textContent = `✗ Error: ${result.error}`;
                }
            } catch (error) {
                status.textContent = `✗ Network error: ${error.message}`;
            }
        }
    </script>
</body>
</html>